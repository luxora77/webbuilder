<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Web Studio Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-main: #0f172a;
            --bg-side: #1e293b;
            --accent: #6366f1;
        }
        body { 
            min-height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            background-color: var(--bg-main);
            color: white;
            font-family: 'Inter', system-ui, sans-serif;
        }
        .glass-blur { backdrop-filter: blur(12px); background: rgba(30, 41, 59, 0.7); }
        .code-font { font-family: 'Fira Code', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        #preview-frame { background: white; border-radius: 8px; width: 100%; height: 100%; border: none; }
        .project-item.active { border-left: 4px solid var(--accent); background: rgba(99, 102, 241, 0.1); }
    </style>
</head>
<body>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-64 bg-[#0b0f1a] border-r border-slate-800 flex flex-col flex-shrink-0">
            <div class="p-4">
                <button onclick="createNewProject()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-all">
                    <span>+</span> New Project
                </button>
            </div>
            
            <div id="project-list" class="flex-1 overflow-y-auto px-2 space-y-1">
                </div>

            <div class="p-4 border-t border-slate-800">
                <button onclick="toggleModal('settings-modal')" class="flex items-center gap-3 text-slate-400 hover:text-white transition-colors w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                    Settings
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0">
            <header class="h-14 border-b border-slate-800 flex items-center justify-between px-4 bg-[#0f172a]">
                <div class="flex items-center gap-1.5">
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                </div>

                <div class="flex bg-slate-800 rounded-lg p-1">
                    <button id="btn-preview" onclick="setView('preview')" class="px-4 py-1 rounded-md text-sm font-medium bg-slate-700 text-white">Preview</button>
                    <button id="btn-code" onclick="setView('code')" class="px-4 py-1 rounded-md text-sm font-medium text-slate-400 hover:text-white">Code</button>
                </div>

                <button onclick="downloadCode()" class="bg-slate-800 hover:bg-slate-700 text-slate-200 px-3 py-1.5 rounded-lg text-sm flex items-center gap-2 border border-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Export
                </button>
            </header>

            <div class="flex-1 relative overflow-hidden p-4">
                <div id="preview-container" class="w-full h-full">
                    <iframe id="preview-frame" sandbox="allow-scripts allow-modals"></iframe>
                </div>
                <div id="code-container" class="w-full h-full hidden">
                    <textarea id="code-editor" class="w-full h-full bg-[#050505] text-green-400 p-4 code-font rounded-lg border border-slate-800 outline-none resize-none" readonly></textarea>
                </div>
            </div>

            <footer class="flex-shrink-0 p-4 border-t border-slate-800 bg-[#0f172a]">
                <div class="max-w-4xl mx-auto flex gap-3">
                    <textarea id="user-input" rows="1" placeholder="Describe the website or changes you want..." 
                        class="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white resize-none"></textarea>
                    <button id="send-btn" onclick="generateWeb()" class="bg-indigo-600 hover:bg-indigo-500 px-6 py-2 rounded-xl font-bold transition-all disabled:opacity-50">
                        Generate
                    </button>
                </div>
            </footer>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-md rounded-2xl p-6">
            <h2 class="text-xl font-bold mb-4">API Settings</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase mb-1">OpenRouter API URL</label>
                    <input id="setting-url" type="text" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 outline-none focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase mb-1">API Key</label>
                    <input id="setting-key" type="password" placeholder="sk-or-..." class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 outline-none focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase mb-1">Model ID</label>
                    <input id="setting-model" type="text" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 outline-none focus:border-indigo-500">
                </div>
            </div>
            <div class="mt-6 flex gap-3">
                <button onclick="saveSettings()" class="flex-1 bg-indigo-600 py-2 rounded-lg font-bold">Save Changes</button>
                <button onclick="toggleModal('settings-modal')" class="flex-1 bg-slate-700 py-2 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const SYSTEM_PROMPT = `You are a world-class web developer. 
        Output ONLY raw, valid, single-file HTML including Tailwind CSS (CDN) and any necessary JS/CSS. 
        Do not explain. Do not use code blocks. Start immediately with <!DOCTYPE html>.
        If the user asks for changes, rewrite the entire file to incorporate them.`;

        let state = {
            projects: JSON.parse(localStorage.getItem('studio_projects') || '[]'),
            activeProjectId: null,
            settings: JSON.parse(localStorage.getItem('studio_settings') || JSON.stringify({
                url: "https://openrouter.ai/api/v1/chat/completions",
                key: "",
                model: "deepseek/deepseek-r1:free"
            }))
        };

        // Initialization
        window.onload = () => {
            initSettingsFields();
            renderProjectList();
            if (state.projects.length > 0) {
                loadProject(state.projects[0].id);
            }
        };

        function initSettingsFields() {
            document.getElementById('setting-url').value = state.settings.url;
            document.getElementById('setting-key').value = state.settings.key;
            document.getElementById('setting-model').value = state.settings.model;
        }

        function toggleModal(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
        }

        function saveSettings() {
            state.settings = {
                url: document.getElementById('setting-url').value,
                key: document.getElementById('setting-key').value,
                model: document.getElementById('setting-model').value
            };
            localStorage.setItem('studio_settings', JSON.stringify(state.settings));
            toggleModal('settings-modal');
        }

        async function generateWeb() {
            const input = document.getElementById('user-input');
            const btn = document.getElementById('send-btn');
            const prompt = input.value.trim();
            
            if (!prompt) return;
            if (!state.settings.key) {
                alert("Please add your OpenRouter API Key in Settings!");
                return toggleModal('settings-modal');
            }

            btn.disabled = true;
            btn.innerText = "Building...";

            try {
                const history = getActiveProjectHistory();
                const messages = [
                    { role: "system", content: SYSTEM_PROMPT },
                    ...history,
                    { role: "user", content: prompt }
                ];

                const response = await fetch(state.settings.url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.settings.key}`,
                        'HTTP-Referer': window.location.origin,
                    },
                    body: JSON.stringify({
                        model: state.settings.model,
                        messages: messages
                    })
                });

                // Anti-Crash Logic
                const rawText = await response.text();
                
                if (!response.ok) {
                    alert("API Error: " + rawText);
                    throw new Error(rawText);
                }

                const data = JSON.parse(rawText);
                const generatedCode = data.choices[0].message.content.replace(/```html|```/g, '').trim();

                updateProject(prompt, generatedCode);
                input.value = "";
            } catch (err) {
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.innerText = "Generate";
            }
        }

        function updateProject(prompt, code) {
            if (!state.activeProjectId) {
                const newProj = {
                    id: Date.now(),
                    name: prompt.substring(0, 20) + "...",
                    code: code,
                    history: [{ role: "user", content: prompt }, { role: "assistant", content: code }]
                };
                state.projects.unshift(newProj);
                state.activeProjectId = newProj.id;
            } else {
                const proj = state.projects.find(p => p.id === state.activeProjectId);
                proj.code = code;
                proj.history.push({ role: "user", content: prompt }, { role: "assistant", content: code });
            }
            saveAndRefresh();
        }

        function createNewProject() {
            state.activeProjectId = null;
            document.getElementById('preview-frame').srcdoc = "";
            document.getElementById('code-editor').value = "";
            document.getElementById('user-input').value = "";
            renderProjectList();
        }

        function loadProject(id) {
            state.activeProjectId = id;
            const proj = state.projects.find(p => p.id === id);
            if (proj) {
                document.getElementById('preview-frame').srcdoc = proj.code;
                document.getElementById('code-editor').value = proj.code;
            }
            renderProjectList();
        }

        function saveAndRefresh() {
            localStorage.setItem('studio_projects', JSON.stringify(state.projects));
            renderProjectList();
            loadProject(state.activeProjectId);
        }

        function renderProjectList() {
            const container = document.getElementById('project-list');
            container.innerHTML = state.projects.map(p => `
                <div onclick="loadProject(${p.id})" class="project-item p-3 rounded-lg cursor-pointer transition-all hover:bg-slate-800 text-sm truncate ${state.activeProjectId === p.id ? 'active text-white' : 'text-slate-400'}">
                    ${p.name}
                </div>
            `).join('');
        }

        function getActiveProjectHistory() {
            if (!state.activeProjectId) return [];
            return state.projects.find(p => p.id === state.activeProjectId).history.slice(-4);
        }

        function setView(view) {
            const isPreview = view === 'preview';
            document.getElementById('preview-container').classList.toggle('hidden', !isPreview);
            document.getElementById('code-container').classList.toggle('hidden', isPreview);
            
            document.getElementById('btn-preview').className = isPreview ? 'px-4 py-1 rounded-md text-sm font-medium bg-slate-700 text-white' : 'px-4 py-1 rounded-md text-sm font-medium text-slate-400 hover:text-white';
            document.getElementById('btn-code').className = !isPreview ? 'px-4 py-1 rounded-md text-sm font-medium bg-slate-700 text-white' : 'px-4 py-1 rounded-md text-sm font-medium text-slate-400 hover:text-white';
        }

        function downloadCode() {
            const code = document.getElementById('code-editor').value;
            if (!code) return alert("Nothing to download");
            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'index.html';
            a.click();
        }
    </script>
</body>
</html>
